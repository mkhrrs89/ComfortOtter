<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ModelMatchup → Firebase Migration</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #050510;
      color: #f5f5f5;
      padding: 2.5rem 2rem;
      font-size: 18px;
      line-height: 1.6;
    }
    h1 {
      margin-bottom: 0.75rem;
      font-size: 2rem;
    }
    button {
      padding: 0.85rem 1.6rem;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 1.05rem;
      font-weight: 600;
      margin-right: 0.9rem;
    }
    #migrateBtn {
      background: linear-gradient(135deg, #14b8a6, #0f766e);
      color: #020617;
      box-shadow: 0 8px 18px rgba(20, 184, 166, 0.35);
    }
    #status {
      margin-top: 1.1rem;
      font-size: 1.05rem;
      font-weight: 500;
    }
    #log {
      margin-top: 1.25rem;
      padding: 1.25rem;
      background: #020617;
      border-radius: 0.9rem;
      max-height: 60vh;
      overflow: auto;
      font-size: 0.95rem;
      white-space: pre-wrap;
      border: 1px solid #123427;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }
    .toolbar {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 16px;
    }
    .tab {
      background: #0b1224;
      color: #f5f5f5;
      border: 1px solid #123427;
      padding: 10px 14px;
      border-radius: 999px;
      cursor: pointer;
      font-size: 15px;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      min-height: 44px;
    }
    .tab.active {
      outline: 2px solid #16a085;
      background: linear-gradient(135deg, #1f9d73, #157457);
      box-shadow: 0 8px 18px rgba(22, 160, 133, 0.35);
    }
  </style>
</head>
<body>
  <h1>ModelMatchup → Firebase Migration</h1>
  <p>This tool uploads any items that still have <code>dataUrl</code> and no <code>fullUrl</code> into Firebase Storage + Firestore.</p>

  <div class="toolbar">
    <a href="index.html" class="tab">← Back to Library</a>
    <a href="sizes.html" class="tab">Image Sizes</a>
    <a href="duplicates.html" class="tab">Title Twins</a>
    <a href="normalize-urls.html" class="tab">Normalize URLs</a>
    <a href="unmigrated-report.html" class="tab">Unmigrated Report</a>
    <a href="migrate.html" class="tab active">Firebase Migration</a>
  </div>

  <button id="migrateBtn">Migrate unmigrated items</button>
  <span id="status"></span>

  <pre id="log"></pre>

  <script type="module">
    // --- Firebase imports ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";

    // --- Comforting Otter config (same project) ---
    const firebaseConfig = {
      apiKey: "AIzaSyBOVGz7QH_iPtxoM25baGqTIR-2yxUQwH8",
      authDomain: "comforting-otter.firebaseapp.com",
      projectId: "comforting-otter",
      storageBucket: "comforting-otter.firebasestorage.app",
      messagingSenderId: "1074346290690",
      appId: "1:1074346290690:web:bd2721e73fbdf029e7411b",
      measurementId: "G-2JT31JFGNJ"
    };

    const app     = initializeApp(firebaseConfig);
    const auth    = getAuth(app);
    const db      = getFirestore(app);
    const storage = getStorage(app);

    signInAnonymously(auth).catch(console.error);

    // --- IndexedDB helpers ---
    const DB_NAME  = "modelMatchupDB";
    const DB_STORE = "items";

    function openDB() {
      return new Promise((resolve, reject) => {
        const req = indexedDB.open(DB_NAME, 1);
        req.onupgradeneeded = () => {
          const db = req.result;
          if (!db.objectStoreNames.contains(DB_STORE)) {
            db.createObjectStore(DB_STORE, { keyPath: "id" });
          }
        };
        req.onsuccess = () => resolve(req.result);
        req.onerror   = () => reject(req.error);
      });
    }

    function idbPut(item){
      return openDB().then(db => {
        return new Promise((resolve, reject) => {
          const tx = db.transaction(DB_STORE, "readwrite");
          tx.objectStore(DB_STORE).put(item);
          tx.oncomplete = () => resolve();
          tx.onerror    = () => reject(tx.error);
        });
      });
    }

    // --- UI helpers ---
    const statusEl = document.getElementById("status");
    const logEl    = document.getElementById("log");
    const btn      = document.getElementById("migrateBtn");

    function setStatus(text){
      statusEl.textContent = text;
    }

    function log(text){
      const ts = new Date().toISOString().slice(11, 19);
      logEl.textContent += `[${ts}] ${text}\n`;
      logEl.scrollTop = logEl.scrollHeight;
    }

    // --- Migration logic ---

    function stripBigFields(item){
      const { dataUrl, thumbnail, thumbDataUrl, ...rest } = item || {};
      return rest || {};
    }

    async function migrateItem(item){
      if (!item || !item.id) return "skip";
      if (!item.dataUrl) return "skip";           // nothing to upload
      if (item.fullUrl)  return "skipAlready";    // already migrated

      // dataUrl → Blob
      const res  = await fetch(item.dataUrl);
      const blob = await res.blob();

      const path       = `images/${item.id}.jpg`;
      const storageRef = ref(storage, path);

      const snap    = await uploadBytes(storageRef, blob);
      const fullUrl = await getDownloadURL(snap.ref);

      const meta = {
        ...stripBigFields(item),
        fullUrl,
        updatedAt: new Date().toISOString()
      };

      await setDoc(doc(db, "images", item.id), meta, { merge: true });

      // mark as migrated locally
      item.fullUrl = fullUrl;
      await idbPut(item);

      return "migrated";
    }

    // Collect all unmigrated items first (no async inside cursor callback)
    async function collectUnmigrated(){
      const db = await openDB();
      const tx = db.transaction(DB_STORE, "readonly");
      const store = tx.objectStore(DB_STORE);
      const itemsToMigrate = [];

      return new Promise((resolve, reject) => {
        const req = store.openCursor();
        req.onsuccess = e => {
          const cursor = e.target.result;
          if (!cursor){
            resolve(itemsToMigrate);
            return;
          }
          const item = cursor.value;
          if (item && item.dataUrl && !item.fullUrl){
            itemsToMigrate.push(item);
          }
          cursor.continue();
        };
        req.onerror = () => reject(req.error);
      });
    }

    async function migrateAll(){
      btn.disabled = true;
      setStatus("Starting migration...");
      log("Opening IndexedDB…");

      const items = await collectUnmigrated();
      log(`Found ${items.length} items that still need migration.`);

      let migrated = 0;
      let skipped  = 0;
      let failed   = 0;

      for (const item of items){
        try {
          const result = await migrateItem(item);
          if (result === "migrated") {
            migrated++;
            log(`Migrated ${item.id}`);
          } else {
            skipped++;
          }
        } catch (err){
          failed++;
          log(`ERROR for ${item.id}: ${err.message || err}`);
        }
      }

      setStatus(`Done. Migrated ${migrated}, skipped ${skipped}, failed ${failed}.`);
      log("Migration complete.");
      btn.disabled = false;
    }

    btn.addEventListener("click", () => {
      migrateAll().catch(err => {
        log("Unexpected error: " + (err.message || err));
        btn.disabled = false;
      });
    });
  </script>
</body>
</html>
