<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ModelMatchup ‚Äì Unmigrated Images Report</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="app-style.css" />
  <style>
    body {
      background:#050510;
      color:#e7f5ef;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      padding:20px;
    }
    h1 { margin-bottom:4px; }
    .sub { color:#9fb6c4; font-size:14px; margin-bottom:16px; }
    #scanBtn {
      padding:0.6rem 1.2rem;
      border-radius:999px;
      border:none;
      cursor:pointer;
      font-weight:600;
      background:linear-gradient(135deg,#16a085,#1abc9c);
      color:#041014;
      margin-bottom:12px;
    }
    #status { font-size:13px; color:#9fb6c4; margin-bottom:8px; }
    table {
      width:100%;
      border-collapse:collapse;
      font-size:13px;
      margin-top:8px;
    }
    th, td {
      padding:6px 8px;
      border-bottom:1px solid rgba(255,255,255,0.04);
      text-align:left;
      vertical-align:top;
      word-break:break-all;
    }
    th { font-weight:600; color:#c6dde7; background:rgba(255,255,255,0.02); }
    tr:nth-child(even) { background:rgba(255,255,255,0.01); }
    .pill {
      display:inline-block;
      padding:2px 6px;
      border-radius:999px;
      font-size:11px;
      background:rgba(255,255,255,0.06);
      color:#e7f5ef;
    }
    #summary { font-size:13px; margin-top:6px; color:#c6dde7; }
    #log {
      margin-top:12px;
      background:rgba(0,0,0,0.35);
      border-radius:6px;
      padding:8px;
      font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:11px;
      max-height:220px;
      overflow:auto;
      white-space:pre-wrap;
    }
</style>
</head>
<body>
  <header class="pageHeader">
    <div>
      <h1>Unmigrated Images Report</h1>
      <div class="sub">
        Shows any records in <code>modelMatchupDB / items</code> that don‚Äôt have a <code>fullUrl</code>.
        These are the ones that still need to be migrated to Firebase.
      </div>
    </div>
    <div class="navMenuShell">
      <details class="navDropdown">
        <summary class="navTrigger">Menu ‚ñæ</summary>
        <div class="navMenuList">
          <a class="navItem" href="index.html?tab=Library">Library</a>
          <a class="navItem" href="index.html?tab=Matchups">Matchups</a>
          <a class="navItem" href="index.html?tab=Stats">Stats</a>
          <a class="navItem" href="index.html?tab=Collections">Collections</a>
          <div class="navSpacer"></div>
          <a class="navItem" href="tourney.html">Tournament</a>
          <a class="navItem" href="settings.html">Settings</a>
        </div>
      </details>
    </div>
  </header>

  <div style="margin-bottom:12px;display:flex;gap:10px;flex-wrap:wrap;">
    <a href="index.html" class="tab">‚Üê Back to Library</a>
    <a href="sizes.html" class="tab">Image Sizes</a>
    <a href="duplicates.html" class="tab">Title Twins</a>
    <a href="normalize-urls.html" class="tab">Normalize URLs</a>
    <a href="unmigrated-report.html" class="tab active">Unmigrated Report</a>
    <a href="migrate.html" class="tab">Firebase Migration</a>
  </div>

  <button id="scanBtn">Scan IndexedDB</button>
  <div id="status"></div>
  <div id="summary"></div>

  <table id="resultsTable" style="display:none;">
    <thead>
      <tr>
        <th>ID</th>
        <th>Title</th>
        <th>Has dataUrl?</th>
        <th>Has thumbnail?</th>
      </tr>
    </thead>
    <tbody id="resultsBody"></tbody>
  </table>

  <pre id="log"></pre>

  <script>
    // --- IndexedDB helpers (same as normalize-urls) ---
    const DB_NAME  = 'modelMatchupDB';
    const DB_STORE = 'items';

    function openDB() {
      return new Promise((resolve, reject) => {
        const req = indexedDB.open(DB_NAME);
        req.onupgradeneeded = () => {
          const db = req.result;
          if (!db.objectStoreNames.contains(DB_STORE)) {
            db.createObjectStore(DB_STORE, { keyPath: 'id' });
          }
        };
        req.onsuccess = () => resolve(req.result);
        req.onerror   = () => reject(req.error);
      });
    }

    function idbGetAll() {
      return openDB().then(db => {
        return new Promise((resolve, reject) => {
          const tx = db.transaction(DB_STORE, 'readonly');
          const store = tx.objectStore(DB_STORE);
          const rows = [];
          const req = store.openCursor();
          req.onsuccess = e => {
            const cursor = e.target.result;
            if (!cursor) { resolve(rows); return; }
            rows.push(cursor.value);
            cursor.continue();
          };
          req.onerror = () => reject(req.error);
        });
      });
    }

    // --- UI bits ---
    const scanBtn  = document.getElementById('scanBtn');
    const statusEl = document.getElementById('status');
    const summaryEl= document.getElementById('summary');
    const table    = document.getElementById('resultsTable');
    const tbody    = document.getElementById('resultsBody');
    const logEl    = document.getElementById('log');

    function setStatus(msg) {
      statusEl.textContent = msg;
    }
    function log(msg) {
      logEl.textContent += msg + '\\n';
      logEl.scrollTop = logEl.scrollHeight;
    }

    function renderRows(items) {
      tbody.innerHTML = '';
      if (!items.length) {
        table.style.display = 'none';
        return;
      }
      table.style.display = 'table';

      for (const item of items) {
        const tr = document.createElement('tr');

        const hasDataUrl = !!item.dataUrl;
        const hasThumb   = !!item.thumbnail || !!item.thumbDataUrl;

        const tdId    = document.createElement('td');
        const tdTitle = document.createElement('td');
        const tdData  = document.createElement('td');
        const tdThumb = document.createElement('td');

        tdId.textContent = item.id || '(no id)';
        tdTitle.textContent = item.title || '';

        tdData.innerHTML  = hasDataUrl ? '<span class="pill">yes</span>' : '<span class="pill">no</span>';
        tdThumb.innerHTML = hasThumb   ? '<span class="pill">yes</span>' : '<span class="pill">no</span>';

        tr.appendChild(tdId);
        tr.appendChild(tdTitle);
        tr.appendChild(tdData);
        tr.appendChild(tdThumb);

        tbody.appendChild(tr);
      }
    }

    async function runScan() {
      scanBtn.disabled = true;
      statusEl.textContent = '';
      summaryEl.textContent = '';
      logEl.textContent = '';

      try {
        setStatus('Loading all records from IndexedDB‚Ä¶');
        const items = await idbGetAll();
        log('Total records in DB: ' + items.length);

        const unmigrated = [];
        let withFullUrl = 0;

        for (const item of items) {
          if (item && item.fullUrl) {
            withFullUrl++;
          } else {
            unmigrated.push(item);
          }
        }

        renderRows(unmigrated);

        summaryEl.textContent =
          'Records with fullUrl: ' + withFullUrl +
          ' ¬∑ Without fullUrl (unmigrated): ' + unmigrated.length;

        setStatus('Scan complete.');
        if (!unmigrated.length) {
          log('All records have fullUrl üéâ');
        } else {
          log('Unmigrated records listed above.');
        }
      } catch (err) {
        console.error(err);
        setStatus('Error during scan.');
        log('ERROR: ' + (err.message || err));
      } finally {
        scanBtn.disabled = false;
      }
    }

    scanBtn.addEventListener('click', () => {
      runScan().catch(err => {
        console.error(err);
        setStatus('Unexpected error, see console.');
        scanBtn.disabled = false;
      });
    });
  </script>
</body>
</html>
