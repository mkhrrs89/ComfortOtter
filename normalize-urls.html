<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ModelMatchup – URL & Thumbnail Normalizer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="app-style.css" />
  <style>
    body {
      background:#050510;
      color:#e7f5ef;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      padding:20px;
    }
    h1 { margin-bottom:4px; }
    .sub { color:#9fb6c4; font-size:14px; margin-bottom:16px; }
    button {
      background:#0ea5e9;
      color:#020617;
      border:none;
      border-radius:999px;
      padding:8px 16px;
      font-size:14px;
      cursor:pointer;
    }
    button[disabled]{
      opacity:.6;
      cursor:default;
    }
    #status { margin-top:10px; font-size:14px; }
    #log {
      margin-top:16px;
      max-height:60vh;
      overflow:auto;
      font-size:12px;
      background:#020617;
      border-radius:12px;
      padding:10px;
      white-space:pre-wrap;
    }
  </style>
</head>
<body>
  <header class="pageHeader">
    <div>
      <h1>URL & Thumbnail Normalizer</h1>
      <div class="sub">
    This passes over <code>modelMatchupDB</code> and standardizes each record:<br/>
    • <code>thumbnail</code> becomes the one true thumb field (copying from <code>thumbDataUrl</code> if needed).<br/>
    • <code>thumbDataUrl</code> is removed when redundant.<br/>
    • Optionally, <code>dataUrl</code> is dropped when a <code>fullUrl</code> exists (toggle below).
      </div>
    </div>
    <div class="navMenuShell">
      <details class="navDropdown">
        <summary class="navTrigger">Menu ▾</summary>
        <div class="navMenuList">
          <a class="navItem" href="index.html?tab=Library">Library</a>
          <a class="navItem" href="index.html?tab=Matchups">Matchups</a>
          <a class="navItem" href="index.html?tab=Stats">Stats</a>
          <a class="navItem" href="index.html?tab=Collections">Collections</a>
          <div class="navSpacer"></div>
          <a class="navItem" href="tourney.html">Tournament</a>
          <a class="navItem" href="settings.html">Settings</a>
        </div>
      </details>
    </div>
  </header>

  <div style="margin-bottom:12px;display:flex;gap:10px;flex-wrap:wrap;">
    <a href="index.html" class="tab">← Back to Library</a>
    <a href="sizes.html" class="tab">Image Sizes</a>
    <a href="duplicates.html" class="tab">Title Twins</a>
    <a href="normalize-urls.html" class="tab active">Normalize URLs</a>
    <a href="unmigrated-report.html" class="tab">Unmigrated Report</a>
    <a href="migrate.html" class="tab">Firebase Migration</a>
  </div>

  <label style="display:flex;align-items:center;gap:6px;font-size:13px;margin-bottom:10px;">
    <input type="checkbox" id="dropDataWithFull" checked />
    Remove <code>dataUrl</code> when a <code>fullUrl</code> is present (recommended once you trust Firebase).
  </label>

  <button id="runBtn">Scan & normalize records</button>
  <div id="status"></div>
  <pre id="log"></pre>

  <script>
    const DB_NAME  = 'modelMatchupDB';
    const DB_STORE = 'items';

    function openDB() {
      return new Promise((resolve, reject) => {
        const req = indexedDB.open(DB_NAME);
        req.onupgradeneeded = () => {
          const db = req.result;
          if (!db.objectStoreNames.contains(DB_STORE)) {
            db.createObjectStore(DB_STORE, { keyPath: 'id' });
          }
        };
        req.onsuccess = () => resolve(req.result);
        req.onerror   = () => reject(req.error);
      });
    }

    function idbGetAll() {
      return openDB().then(db => {
        return new Promise((resolve, reject) => {
          const tx = db.transaction(DB_STORE, 'readonly');
          const store = tx.objectStore(DB_STORE);
          const rows = [];
          const req = store.openCursor();
          req.onsuccess = e => {
            const cursor = e.target.result;
            if (!cursor) { resolve(rows); return; }
            rows.push(cursor.value);
            cursor.continue();
          };
          req.onerror = () => reject(req.error);
        });
      });
    }

    function idbPut(item) {
      return openDB().then(db => {
        return new Promise((resolve, reject) => {
          const tx = db.transaction(DB_STORE, 'readwrite');
          tx.objectStore(DB_STORE).put(item);
          tx.oncomplete = () => resolve();
          tx.onerror    = () => reject(tx.error);
        });
      });
    }

    const statusEl = document.getElementById('status');
    const logEl    = document.getElementById('log');
    const runBtn   = document.getElementById('runBtn');
    const dropDataCheckbox = document.getElementById('dropDataWithFull');

    function setStatus(msg) {
      statusEl.textContent = msg;
    }
    function log(msg) {
      logEl.textContent += msg + '\n';
      logEl.scrollTop = logEl.scrollHeight;
    }

async function normalizeAll() {
  runBtn.disabled = true;
  logEl.textContent = '';

  const isRemoteUrl = (u) => typeof u === 'string' && /^https?:\/\//i.test(u);

  try {
    setStatus('Counting records…');

    const db = await openDB();

    // Count records without loading them
    const total = await new Promise((resolve, reject) => {
      const tx = db.transaction(DB_STORE, 'readonly');
      const store = tx.objectStore(DB_STORE);
      const req = store.count();
      req.onsuccess = () => resolve(req.result || 0);
      req.onerror = () => reject(req.error);
    });

    log(`Found ${total} items.`);

    let processed = 0;
    let changed = 0;
    let thumbFixes = 0;
    let thumbDrops = 0;
    let dataDrops  = 0;

    // stats
    let withThumb = 0;
    let withThumbData = 0;
    let withDataUrl = 0;
    let withFullUrl = 0;

    const dropDataWhenFull = dropDataCheckbox.checked;

    setStatus(`Normalizing… 0 / ${total}`);

    await new Promise((resolve, reject) => {
      const tx = db.transaction(DB_STORE, 'readwrite');
      const store = tx.objectStore(DB_STORE);
      const req = store.openCursor();

      tx.oncomplete = () => resolve();
      tx.onerror = () => reject(tx.error);

      const updateStatus = () => {
        if (processed % 250 === 0 || processed === total) {
          setStatus(`Normalizing… ${processed} / ${total}`);
        }
      };

      req.onerror = () => reject(req.error);

      req.onsuccess = (e) => {
        const cursor = e.target.result;
        if (!cursor) return; // done

        const item = cursor.value;

        if (!item || !item.id) {
          processed++;
          updateStatus();
          cursor.continue();
          return;
        }

        let dirty = false;

        const origThumb     = item.thumbnail || null;
        const origThumbData = item.thumbDataUrl || null;
        const origDataUrl   = item.dataUrl || null;
        const origFullUrl   = item.fullUrl || null;

        if (origThumb)     withThumb++;
        if (origThumbData) withThumbData++;
        if (origDataUrl)   withDataUrl++;
        if (origFullUrl)   withFullUrl++;

        // 1) Normalize thumbnail field
        const preferredThumb = origThumb || origThumbData || null;
        if (preferredThumb && preferredThumb !== origThumb) {
          item.thumbnail = preferredThumb;
          thumbFixes++;
          dirty = true;
        }

        if (item.thumbDataUrl && item.thumbDataUrl === item.thumbnail) {
          delete item.thumbDataUrl;
          thumbDrops++;
          dirty = true;
        }

        // 2) Optionally drop dataUrl when fullUrl is a real remote URL
        if (dropDataWhenFull && isRemoteUrl(origFullUrl) && origDataUrl) {
          delete item.dataUrl;
          dataDrops++;
          dirty = true;
        }

        const goNext = () => {
          processed++;
          updateStatus();
          cursor.continue();
        };

        if (!dirty) {
          goNext();
          return;
        }

        const ureq = cursor.update(item);
        ureq.onsuccess = () => {
          changed++;
          goNext();
        };
        ureq.onerror = () => reject(ureq.error);
      };
    });

    setStatus(`Done. Updated ${changed} items.`);
    log(`Records with thumbnail:      ${withThumb}`);
    log(`Records with thumbDataUrl:   ${withThumbData}`);
    log(`Records with dataUrl:        ${withDataUrl}`);
    log(`Records with fullUrl:        ${withFullUrl}`);
    log('---');
    log(`Thumbnail fixed / set:       ${thumbFixes}`);
    log(`Redundant thumbDataUrl drop: ${thumbDrops}`);
    log(`dataUrl removed (fullUrl):   ${dataDrops}`);
    log('All done ✅');
  } catch (err) {
    console.error(err);
    setStatus('Error during normalization.');
    log('ERROR: ' + (err?.message || err));
  } finally {
    runBtn.disabled = false;
  }
}

    runBtn.addEventListener('click', () => {
      normalizeAll().catch(err => {
        console.error(err);
        setStatus('Unexpected error. See console.');
        runBtn.disabled = false;
      });
    });
  </script>
</body>
</html>
